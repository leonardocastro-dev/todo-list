name: Deploy to VM

on:
  push:
    branches: ['main']

env:
  SETUP_SCRIPT: |
    set -e
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
    nvm use --lts
    corepack enable
    corepack prepare pnpm@latest --activate
    cd /home/deploy/workspace/fokuz

jobs:
  pull:
    name: Pull latest code
    runs-on: ubuntu-latest
    steps:
      - name: Pull
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            set -e
            cd /home/deploy/workspace/fokuz
            git fetch --all
            git reset --hard origin/main

  install:
    name: Install dependencies
    needs: pull
    runs-on: ubuntu-latest
    steps:
      - name: Install
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            ${{ env.SETUP_SCRIPT }}
            pnpm install --frozen-lockfile

  checks:
    name: Run checks
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Formatting, Lint & Type check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            ${{ env.SETUP_SCRIPT }}
            echo "--- Checking formatting ---"
            pnpm run prettier
            echo "--- Linting ---"
            pnpm run lint
            echo "--- Type checking ---"
            pnpm run typecheck

  build:
    name: Build
    needs: checks
    runs-on: ubuntu-latest
    steps:
      - name: Build
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            ${{ env.SETUP_SCRIPT }}
            pnpm run build

  restart:
    name: Restart app
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            ${{ env.SETUP_SCRIPT }}
            pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production
            pm2 save
